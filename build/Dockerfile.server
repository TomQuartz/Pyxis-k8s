FROM golang:1.22.9 as BUILDER

ARG TARGET

WORKDIR /src

COPY . .

# Cache for repeated builds
RUN go mod download

RUN go build -mod=readonly -v -o build/${TARGET} cmd/${TARGET}/main.go

FROM debian:stable-slim

WORKDIR /pyxis

# Copy the binary to the production image from the BUILDER stage.
COPY --from=BUILDER /src/build/${TARGET} /pyxis/${TARGET}